#cloud-config
# ─────────────────────────────────────────────────────────────────
# PR Review Agent — Hetzner cloud-init
#
# GENERATED FILE — do not edit directly.
# Edit the source files and run: just build
#
# POST-PROVISION STEPS (do these manually after first boot):
#   1. Set up a Cloudflare Tunnel pointing to http://localhost:80
#      (see README for details)
#
#   2. Authenticate the review user:
#        sudo -u review gh auth login          # GitHub OAuth
#        sudo -u review claude                  # Claude subscription login
#
#   3. Configure an org-level webhook in GitHub:
#        URL:    https://<tunnel-hostname>/webhook
#        Secret: (value from /opt/pr-review/.env)
#        Events: Pull requests
#
#   4. Start the service:
#        sudo systemctl start pr-review
# ─────────────────────────────────────────────────────────────────

package_update: true
package_upgrade: true

packages:
  - python3
  - git
  - jq
  - ufw
  - debian-keyring
  - debian-archive-keyring
  - apt-transport-https
  - curl

write_files:
  # ── Main agent ────────────────────────────────────────────────
  - path: /opt/pr-review/agent.py
    permissions: "0755"
    content: |
      {{FILE:src/agent.py}}

  # ── Review prompt template ──────────────────────────────────
  - path: /opt/pr-review/prompt.md
    permissions: "0644"
    content: |
      {{FILE:src/prompt.md}}

  # ── Systemd service ───────────────────────────────────────
  - path: /etc/systemd/system/pr-review.service
    content: |
      [Unit]
      Description=GitHub PR Review Agent
      After=network.target caddy.service
      Wants=caddy.service

      [Service]
      Type=simple
      User=review
      Group=review
      WorkingDirectory=/opt/pr-review
      EnvironmentFile=/opt/pr-review/.env
      Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/review/.npm-global/bin
      ExecStart=/usr/bin/python3 /opt/pr-review/agent.py
      Restart=always
      RestartSec=10

      # Security hardening
      NoNewPrivileges=yes
      ProtectSystem=strict
      ReadWritePaths=/opt/pr-review /home/review
      PrivateTmp=yes
      ProtectHome=no              # gh config + Claude auth tokens live in ~review/
      ProtectKernelTunables=yes
      ProtectKernelModules=yes
      ProtectControlGroups=yes
      RestrictNamespaces=yes
      RestrictSUIDSGID=yes
      MemoryDenyWriteExecute=no   # Python JIT requires writable+executable memory

      [Install]
      WantedBy=multi-user.target

  # ── Caddy reverse proxy config (written in runcmd after caddy install) ──

runcmd:
  # ── Install Node.js (for Claude Code) ─────────────────────
  # GPG-verified apt repo (same pattern as Caddy and cloudflared above).
  # pipefail ensures a curl failure isn't masked by gpg exiting 0.
  - bash -o pipefail -c 'curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --yes --dearmor -o /usr/share/keyrings/nodesource.gpg'
  # "nodistro" is NodeSource's intentional suite name (not a distro codename like jammy).
  - echo "deb [signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
  - apt-get update && apt-get install -y nodejs
  - npm install -g @anthropic-ai/claude-code@latest
  - echo "Installed claude-code version:" && npm list -g @anthropic-ai/claude-code --depth=0

  # ── Install GitHub CLI ────────────────────────────────────
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /usr/share/keyrings/githubcli-archive-keyring.gpg
  - chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update && apt-get install -y gh

  # ── Install Caddy ─────────────────────────────────────────
  - bash -o pipefail -c 'curl -1sLf https://dl.cloudsmith.io/public/caddy/stable/gpg.key | gpg --yes --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg'
  - bash -o pipefail -c 'curl -1sLf https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt | tee /etc/apt/sources.list.d/caddy-stable.list'
  - chmod o+r /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - chmod o+r /etc/apt/sources.list.d/caddy-stable.list
  - apt-get update && apt-get install -y caddy

  # ── Write Caddy config (after install so it doesn't get overwritten) ──
  # Default: plain HTTP on :80 for Cloudflare Tunnel (tunnel terminates TLS).
  # For Origin CA setup, replace this with a :443 TLS block — see README.
  - |
    cat > /etc/caddy/Caddyfile <<'CADDYEOF'
    {
        auto_https off
    }

    :80 {
        reverse_proxy 127.0.0.1:8080
        request_body {
            max_size 5MB
        }
        log {
            output stdout
            format json
        }
    }

    # Internal health checks only — not exposed externally (UFW blocks 8081)
    :8081 {
        respond /ping "pong" 200
        reverse_proxy /health 127.0.0.1:8080
    }
    CADDYEOF

  # ── Create service user ───────────────────────────────────
  - useradd -r -m -s /bin/bash review

  # ── Generate secrets and write env file ───────────────────
  - |
    WEBHOOK_SECRET=$(openssl rand -hex 32)
    {
      echo "GITHUB_WEBHOOK_SECRET=${WEBHOOK_SECRET}"
      echo "REVIEW_WORKDIR=/opt/pr-review/workspace"
      echo "MAX_WORKERS=4"
      echo "PORT=8080"
    } > /opt/pr-review/.env

  # ── Set up directories and permissions ────────────────────
  - mkdir -p /opt/pr-review/workspace
  - chown -R review:review /opt/pr-review
  - chmod 600 /opt/pr-review/.env

  # ── Install cloudflared (via official apt repo — installs latest) ──
  # Pre-installed for both automated (`just provision`) and manual tunnel setup.
  # To activate: cloudflared service install <TUNNEL_TOKEN>
  # Note: not version-pinned; pin with `cloudflared=<version>` if needed.
  # GPG key hash pinned to guard against supply-chain tampering between
  # key download and package install.  Update the hash if Cloudflare rotates
  # their signing key (curl the URL and pipe through sha256sum).
  - |
    curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg -o /tmp/cloudflare-main.gpg
    echo "1bd95f4082b320d541bee351560fc2765aa9f9cd8efa4c9e32135e63f252721d  /tmp/cloudflare-main.gpg" | sha256sum -c - \
      || { echo "FATAL: cloudflared GPG key hash mismatch — key may have been rotated; update hash in cloud-init.tmpl.yaml"; exit 1; }
    mv /tmp/cloudflare-main.gpg /usr/share/keyrings/cloudflare-main.gpg
  - echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" > /etc/apt/sources.list.d/cloudflared.list
  - apt-get update && apt-get install -y cloudflared

  # ── Firewall — only SSH ──────────────────────────────────
  # Port 80 is intentionally NOT opened: Caddy listens on :80 for the tunnel,
  # but cloudflared connects to it via localhost. No inbound ports needed.
  # For Origin CA setups, `just setup-tls` opens 443 automatically.
  - ufw allow OpenSSH
  - ufw --force enable

  # ── Enable services (don't start pr-review yet — needs auth) ──
  - systemctl daemon-reload
  - systemctl enable caddy
  - systemctl restart caddy
  - systemctl enable pr-review
  - |
    echo ""
    echo "════════════════════════════════════════════════════════"
    echo "  SETUP COMPLETE — manual steps remaining:"
    echo ""
    echo "  1. Set up Cloudflare Tunnel (see README)"
    echo ""
    echo "  2. Authenticate:"
    echo "       sudo -u review gh auth login"
    echo "       sudo -u review claude"
    echo ""
    echo "  3. Start the agent:"
    echo "       systemctl start pr-review"
    echo ""
    echo "  4. Configure org webhook → https://<tunnel-hostname>/webhook"
    echo "       Secret: grep WEBHOOK_SECRET /opt/pr-review/.env | cut -d= -f2"
    echo "════════════════════════════════════════════════════════"

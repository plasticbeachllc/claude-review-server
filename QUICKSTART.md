# Automated PR Reviews with Claude Code

A self-hosted agent that automatically reviews pull requests using Claude Code subscription auth. When a PR is opened or updated in your GitHub org, the agent posts a concise, actionable review comment within a couple of minutes.

## What it does

- Listens for GitHub webhook events on PR open and push
- Fetches the diff via the GitHub CLI
- Sends it to Claude Code for review
- Posts the review as a PR comment
- Collapses old reviews when a PR is force-pushed
- Skips draft PRs
- Smart diff truncation — drops lockfiles and generated code first when diffs are large

## Architecture

```
GitHub webhook → Cloudflare (TLS) → Caddy (reverse proxy) → Python agent → Claude Code CLI → gh pr comment
```

## Prerequisites

- **Hetzner Cloud account** (or any VPS provider — adjust the cloud-init as needed)
- **Cloudflare account** with your domain's DNS managed there
- **GitHub org** with permission to create org-level webhooks
- **Claude Code subscription** (Pro or Max) for `claude setup-token`
- **SSH key** added to your Hetzner account

## Cost

~$4/month for a CX11 server. Claude usage comes from your existing subscription.

---

## Step 1: Create the Cloudflare Origin CA certificate

This certificate encrypts traffic between Cloudflare and your server.

1. In the Cloudflare dashboard, go to your domain
2. Navigate to **SSL/TLS → Origin Server**
3. Click **Create Certificate**
4. Set hostnames to your subdomain (e.g. `pr-review.yourdomain.com`)
5. Leave validity at 15 years
6. Click **Create**
7. **Copy both the Origin Certificate and Private Key** — the private key is only shown once. Save them somewhere secure (e.g. 1Password)

Then under **SSL/TLS → Overview**, set the encryption mode to **Full (Strict)**.

## Step 2: Create the Hetzner server

1. Go to [Hetzner Cloud Console](https://console.hetzner.cloud/) → **Create Server**
2. Configure:
   - **Location:** Whichever is closest to you
   - **Image:** Ubuntu 24.04
   - **Type:** CX11
   - **Networking:** Public IPv4 + IPv6
   - **SSH Key:** Select your key
   - **Cloud config:** Expand the section at the bottom and paste the entire contents of [`cloud-init.yaml`](./cloud-init.yaml)
   - **Name:** e.g. `pr-review-agent`
3. Click **Create & Buy**
4. Note the server's **IPv4 address**

Wait 3–5 minutes for cloud-init to finish. You can watch the CPU graph in the Hetzner console — it'll spike during package installs then drop when done.

## Step 3: Point your domain at the server

In Cloudflare DNS, add a new record:

| Type | Name        | Content          | Proxy  |
|------|-------------|------------------|--------|
| A    | `pr-review` | `<server IPv4>`  | Proxied (orange cloud ON) |

## Step 4: Generate a Claude Code token

On any machine where you have Claude Code installed:

```bash
claude setup-token
```

This opens a browser for OAuth, then prints a long-lived token (valid ~1 year). Copy it.

## Step 5: Configure the server

SSH into the server:

```bash
ssh -i ~/.ssh/your-key root@<server-ip>
```

Verify cloud-init completed:

```bash
cloud-init status --wait
```

### 5a. Install the Cloudflare Origin CA cert

```bash
nano /etc/caddy/certs/origin.pem
# paste the Origin Certificate, save

nano /etc/caddy/certs/origin-key.pem
# paste the Private Key, save

chmod 644 /etc/caddy/certs/origin.pem
chmod 600 /etc/caddy/certs/origin-key.pem
chown caddy:caddy /etc/caddy/certs/origin-key.pem

systemctl restart caddy
```

### 5b. Authenticate the GitHub CLI

```bash
sudo -u review gh auth login
```

Select: **GitHub.com → HTTPS → Login with a web browser**. It'll give you a one-time code to paste in your browser.

### 5c. Add the Claude Code token

```bash
nano /opt/pr-review/.env
```

Replace `__SET_ME__` on the `CLAUDE_CODE_OAUTH_TOKEN` line with the token from Step 4. The file should look like:

```
GITHUB_WEBHOOK_SECRET=<auto-generated>
CLAUDE_CODE_OAUTH_TOKEN=sk-ant-oat01-...
REVIEW_WORKDIR=/opt/pr-review/workspace
MAX_WORKERS=4
PORT=8080
```

### 5d. Start the agent

```bash
systemctl start pr-review
```

Verify it's running:

```bash
curl http://localhost:8080/health
# → {"status":"healthy"}

journalctl -u pr-review -f
# should show "PR Review Agent listening on 127.0.0.1:8080 (workers=4)"
```

## Step 6: Create the GitHub webhook

1. Go to your GitHub org → **Settings → Webhooks → Add webhook**
2. Configure:
   - **Payload URL:** `https://pr-review.yourdomain.com/webhook`
   - **Content type:** `application/json`
   - **Secret:** Run this on the server to get it:
     ```bash
     grep WEBHOOK_SECRET /opt/pr-review/.env | cut -d= -f2
     ```
   - **Events:** Select **"Let me select individual events"** → check **Pull requests** only
3. Click **Add webhook**
4. Check the **Recent Deliveries** tab — you should see a ping with a `200` response

## Step 7: Test it

Open a pull request on any repo in your org. Within 1–2 minutes, you should see a review comment from your bot.

---

## Troubleshooting

### Webhook returns 404

Make sure you're hitting `/webhook`, not `/`. The agent only responds to `POST /webhook` and `GET /health`.

### Agent won't start

```bash
systemctl status pr-review
journalctl -u pr-review --no-pager -n 30
```

Common causes: missing `GITHUB_WEBHOOK_SECRET` in `.env`, or `.env` has leading whitespace.

### Claude auth errors in logs

Your `CLAUDE_CODE_OAUTH_TOKEN` may have expired. Generate a new one:

```bash
# on any machine with claude installed
claude setup-token
```

Then update `/opt/pr-review/.env` and restart:

```bash
systemctl restart pr-review
```

### Caddy won't start

Usually means the cert files are missing or have wrong permissions:

```bash
ls -la /etc/caddy/certs/
# origin.pem should be 644, origin-key.pem should be 600
# origin-key.pem should be owned by caddy:caddy

journalctl -u caddy --no-pager -n 20
```

### Reviews aren't posting

Check that `gh` can access your repos:

```bash
sudo -u review gh pr list --repo your-org/some-repo
```

If this fails, re-auth: `sudo -u review gh auth login`

---

## Maintenance

| Task | Frequency | How |
|------|-----------|-----|
| Renew Claude token | Yearly | `claude setup-token`, update `.env`, `systemctl restart pr-review` |
| Renew Origin CA cert | Every 15 years | Regenerate in Cloudflare, replace files in `/etc/caddy/certs/` |
| Update Claude Code | As needed | `npm update -g @anthropic-ai/claude-code` |
| Update system packages | Monthly | `apt update && apt upgrade` |
| Check logs | As needed | `journalctl -u pr-review -f` |

## Customization

### Review prompt

Edit the `prompt` variable in `/opt/pr-review/agent.py` (around line 90 in the file on disk) to change what Claude focuses on.

### Diff size limit

The `max_chars` parameter in `smart_truncate_diff` defaults to 40,000 characters. Increase it if you have large PRs and want more coverage (at the cost of slower reviews and more token usage).

### Concurrent reviews

Set `MAX_WORKERS` in `.env` to control how many PRs can be reviewed simultaneously. Default is 4.

### Low-priority file patterns

Edit `LOW_PRIORITY_PATTERNS` in `agent.py` to control which files get dropped first when diffs are truncated. By default, lockfiles, generated code, snapshots, SVGs, and vendored code are deprioritized.
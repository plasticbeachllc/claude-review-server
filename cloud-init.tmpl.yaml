#cloud-config
# ─────────────────────────────────────────────────────────────────
# PR Review Agent — Hetzner cloud-init
#
# GENERATED FILE — do not edit directly.
# Edit the source files and run: just build
#
# POST-PROVISION STEPS (do these manually after first boot):
#   1. Place Cloudflare Origin CA cert + key:
#        /etc/caddy/certs/origin.pem
#        /etc/caddy/certs/origin-key.pem
#      Then: sudo systemctl restart caddy
#
#   2. Authenticate the review user:
#        sudo -u review gh auth login          # GitHub OAuth
#        sudo -u review claude                  # Claude subscription login
#
#   3. Edit /opt/pr-review/.env and set:
#        ALERT_REPO=your-org/your-repo          # for auth-expiry alerts
#        GITHUB_WEBHOOK_SECRET=<from GitHub>     # or keep the generated one
#
#   4. Configure an org-level webhook in GitHub:
#        URL:    https://your-domain.com/webhook
#        Secret: (value from /opt/pr-review/.env)
#        Events: Pull requests
#
#   5. Start the service:
#        sudo systemctl start pr-review
#        sudo systemctl start pr-review-auth-check.timer
# ─────────────────────────────────────────────────────────────────

package_update: true
package_upgrade: true

packages:
  - python3
  - git
  - jq
  - ufw
  - debian-keyring
  - debian-archive-keyring
  - apt-transport-https
  - curl

write_files:
  # ── Main agent ────────────────────────────────────────────────
  - path: /opt/pr-review/agent.py
    permissions: "0755"
    content: |
      {{FILE:agent.py}}

  # ── Review prompt template ──────────────────────────────────
  - path: /opt/pr-review/prompt.md
    permissions: "0644"
    content: |
      {{FILE:prompt.md}}

  # ── Auth health check script ──────────────────────────────
  - path: /opt/pr-review/check-auth.sh
    permissions: "0755"
    content: |
      {{FILE:check-auth.sh}}

  # ── Systemd service ───────────────────────────────────────
  - path: /etc/systemd/system/pr-review.service
    content: |
      [Unit]
      Description=GitHub PR Review Agent
      After=network.target caddy.service
      Wants=caddy.service

      [Service]
      Type=simple
      User=review
      Group=review
      WorkingDirectory=/opt/pr-review
      EnvironmentFile=/opt/pr-review/.env
      Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/review/.npm-global/bin
      ExecStart=/usr/bin/python3 /opt/pr-review/agent.py
      Restart=always
      RestartSec=10

      # Security hardening
      NoNewPrivileges=yes
      ProtectSystem=strict
      ReadWritePaths=/opt/pr-review
      PrivateTmp=yes
      ProtectHome=no
      ProtectKernelTunables=yes
      ProtectKernelModules=yes
      ProtectControlGroups=yes
      RestrictNamespaces=yes
      RestrictSUIDSGID=yes
      MemoryDenyWriteExecute=no

      [Install]
      WantedBy=multi-user.target

  # ── Auth check timer (every 30 min) ──────────────────────
  - path: /etc/systemd/system/pr-review-auth-check.service
    content: |
      [Unit]
      Description=PR Review Agent auth health check

      [Service]
      Type=oneshot
      User=review
      Group=review
      EnvironmentFile=/opt/pr-review/.env
      Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/review/.npm-global/bin
      ExecStart=/opt/pr-review/check-auth.sh

  - path: /etc/systemd/system/pr-review-auth-check.timer
    content: |
      [Unit]
      Description=Run PR Review auth check every 30 minutes

      [Timer]
      OnBootSec=5min
      OnUnitActiveSec=30min
      RandomizedDelaySec=60

      [Install]
      WantedBy=timers.target

  # ── Caddy reverse proxy config (written in runcmd after caddy install) ──

runcmd:
  # ── Install Node.js (for Claude Code) ─────────────────────
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs
  - npm install -g @anthropic-ai/claude-code

  # ── Install GitHub CLI ────────────────────────────────────
  - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /usr/share/keyrings/githubcli-archive-keyring.gpg
  - chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list
  - apt-get update && apt-get install -y gh

  # ── Install Caddy ─────────────────────────────────────────
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
  - chmod o+r /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - chmod o+r /etc/apt/sources.list.d/caddy-stable.list
  - apt-get update && apt-get install -y caddy

  # ── Write Caddy config (after install so it doesn't get overwritten) ──
  - |
    cat > /etc/caddy/Caddyfile <<'CADDYEOF'
    {
        auto_https off
    }

    :443 {
        tls /etc/caddy/certs/origin.pem /etc/caddy/certs/origin-key.pem
        reverse_proxy 127.0.0.1:8080
        request_body {
            max_size 5MB
        }
        log {
            output stdout
            format json
        }
    }

    :8081 {
        respond /ping "pong" 200
        reverse_proxy /health 127.0.0.1:8080
    }
    CADDYEOF

  # ── Create service user ───────────────────────────────────
  - useradd -r -m -s /bin/bash review

  # ── Generate secrets and write env file ───────────────────
  - |
    WEBHOOK_SECRET=$(openssl rand -hex 32)
    cat > /opt/pr-review/.env <<'ENVEOF'
    GITHUB_WEBHOOK_SECRET=__PLACEHOLDER__
    REVIEW_WORKDIR=/opt/pr-review/workspace
    MAX_WORKERS=4
    PORT=8080
    ALERT_REPO=
    ENVEOF
    sed -i "s|__PLACEHOLDER__|${WEBHOOK_SECRET}|" /opt/pr-review/.env
    sed -i 's/^[[:space:]]*//' /opt/pr-review/.env

  # ── Set up directories and permissions ────────────────────
  - mkdir -p /opt/pr-review/workspace
  - mkdir -p /etc/caddy/certs
  - chown -R review:review /opt/pr-review
  - chmod 600 /opt/pr-review/.env

  # ── Firewall — only SSH and HTTPS ─────────────────────────
  - ufw allow OpenSSH
  - ufw allow 443/tcp
  - ufw --force enable

  # ── Enable services (don't start pr-review yet — needs auth) ──
  - systemctl daemon-reload
  - systemctl enable caddy
  - systemctl enable pr-review
  - systemctl enable pr-review-auth-check.timer
  - |
    echo ""
    echo "════════════════════════════════════════════════════════"
    echo "  SETUP COMPLETE — manual steps remaining:"
    echo ""
    echo "  1. Add Cloudflare Origin CA cert:"
    echo "       /etc/caddy/certs/origin.pem"
    echo "       /etc/caddy/certs/origin-key.pem"
    echo "     Then: systemctl restart caddy"
    echo ""
    echo "  2. Authenticate:"
    echo "       sudo -u review gh auth login"
    echo "       sudo -u review claude"
    echo ""
    echo "  3. Edit /opt/pr-review/.env:"
    echo "       Set ALERT_REPO=your-org/repo-name"
    echo ""
    echo "  4. Start the agent:"
    echo "       systemctl start pr-review"
    echo "       systemctl start pr-review-auth-check.timer"
    echo ""
    echo "  5. Configure org webhook → https://your-domain/webhook"
    echo "       Secret: $(cat /opt/pr-review/.env | grep WEBHOOK_SECRET | cut -d= -f2)"
    echo "════════════════════════════════════════════════════════"
